name: Build Workflow
description: Build application
inputs:
   configuration:
     required: true
     default: 'Debug'
   solution_path:
     required: true
     default: ''
   artifacts_path:
     required: true
     default: ''
   allow_push:
     required: true
     default: false
   token:
     required: true
     default: ''

runs:
  using: "composite"
      
  # Steps represent a sequence of tasks that will be executed as part of the job
  steps:

  # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
  - uses: actions/checkout@v2
  
  # Steps represent a sequence of tasks that will be executed as part of the job
  - uses: microsoft/setup-msbuild@v1.1

  - uses: NuGet/setup-nuget@v1.0.5

  - run: nuget sources add -name "github" -Source https://nuget.pkg.github.com/malonejv/index.json -Username malonejv -Password ${ inputs.token }
      
  - run:  nuget restore ${ inputs.solution_path }
    
  - run: msbuild ${ inputs.solution_path } /t:Build /p:Configuration=${ inputs.configuration }
        
  - if: ${ inputs.allow_push }
    run:
         |
          $projects = .\Get-ProjectsInSolution.ps1 ${ inputs.solution_path } -Type NonTestProjects
          $projects | foreach{ nuget pack $_ -Properties Configuration=${ inputs.configuration } -Suffix dev -IncludeReferencedProjects -Symbols -SymbolPackageFormat snupkg -OutputDirectory "${ inputs.artifacts_path }" }
          
  - if: ${ inputs.allow_push }
    uses: actions/upload-artifact@v2
    with:
      name: nuget-packages
      path: ${ inputs.artifacts_path }\*
      if-no-files-found: error
      retention-days: 1
          