name: Build Workflow
description: Build application
inputs:
   configuration:
     required: true
     default: 'Release'
   solution_path:
     required: true
     default: ''
   variables_path:
     required: true
     default: ''
   nuget_source:
     required: true
     default: ''
   nuget_username:
     required: true
     default: ''
   nuget_password:
     required: true
     default: ''
   build_artifact_name:
     required: true
     default: 'build-artifacts'
outputs:
  version_number: 
    description: "Version number"
    value: ${{ steps.version_number.outputs.version_number }}

runs:
  using: "composite"
      
  steps:

  - uses: actions/checkout@v2
  
  - name: Setup MSBuild
    uses: microsoft/setup-msbuild@v1.1

  - name: Setup NuGet
    uses: NuGet/setup-nuget@v1.0.5

  - name: Add GitHub as Nuget Source
    shell: pwsh
    run: nuget sources add -name "github" -Source ${{ inputs.nuget_source }} -Username ${{ inputs.nuget_username }} -Password ${{ inputs.nuget_password }}
    
  - name: Restore Nuget Packages
    shell: pwsh
    run:  nuget restore ${{ inputs.solution_path }}
    
  - name: Update Version
    id: version_number
    shell: pwsh
    run: |
          if(${{ inputs.configuration }} -eq "Release"){$environment="Production"}else{$environment="Development"}
          $solutionDir=${{ inputs.solution_path }} | Split-Path
          $assemblyVersion=.\Get-AssemblyVersion.ps1 -Path "$solutionDir" -FileMask "GlobalAssemblyInfo.cs"
          $newAssemblyVersion=.\Upd-AssemblyVersion.ps1 -CurrentVersionFilePath "$solutionDir\CurrentVersion" -AssemblyVersionFilePath "$solutionDir\GlobalAssemblyInfo.cs" -AssemblyVersion $assemblyVersion -Environment $environment
          Write-Host "Version number: $newAssemblyVersion"
          echo "::set-output name=version_number::$newAssemblyVersion"

  - name: Build application
    shell: pwsh
    run: msbuild ${{ inputs.solution_path }} /t:Build /p:Configuration=${{ inputs.configuration }}

  - name: Preparing artifacts
    shell: pwsh
    run: |
           $buildObjects="build-objects"
           New-Item -Path "${{ github.workspace }}" -Name $buildObjects -ItemType Directory
           $solutionDir = "${{ inputs.solution_path }}" | Split-Path
           $projects = .\Get-ProjectsInSolution.ps1 ${{ inputs.solution_path }} -Type NonTestProjects | Split-Path
           $projects | ForEach-Object { 
              $folderName = Split-Path $_ -Leaf
              New-Item -Path "${{ github.workspace }}\$buildObjects" -Name $folderName -ItemType Directory 
              Copy-Item "$solutionDir\$folderName\bin\" -Destination "${{ github.workspace }}\$buildObjects\$folderName" -Recurse -Container }

              "${{ github.workspace }}\CurrentVersion"
      
  - name: Upload artifacts
    uses: actions/upload-artifact@v2
    with:
      name: "${{ inputs.build_artifact_name }}"
      path: "${{ github.workspace }}\\build-objects\\*"
      if-no-files-found: error
      retention-days: 5